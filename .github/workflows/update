name: update

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Git LFS
        run: |
          git lfs install
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download Latest Models
        run: |
          echo "Downloading models..."
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ models, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          mkdir -p models
          
          # ÐŸÑ€Ð¸Ð¼ÐµÑ€: ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ñ Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ°
          # Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð• URLs ÐÐ Ð’ÐÐ¨Ð˜ Ð Ð•ÐÐ›Ð¬ÐÐ«Ð• Ð˜Ð¡Ð¢ÐžÐ§ÐÐ˜ÐšÐ˜
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ñ Ð¿Ñ€ÑÐ¼Ñ‹Ñ… URL
          # curl -L -o models/arxora_m7pro_AAPL.joblib "https://example.com/models/arxora_m7pro_AAPL.joblib"
          # curl -L -o models/arxora_m7pro_TLT.joblib "https://example.com/models/arxora_m7pro_TLT.joblib"
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð· Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
          # git clone https://github.com/username/models-repo temp-models
          # cp temp-models/*.joblib models/
          # rm -rf temp-models
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð· Hugging Face
          # pip install huggingface-hub
          # python -c "from huggingface_hub import hf_hub_download; hf_hub_download(repo_id='username/models', filename='model.joblib', local_dir='models')"
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 4: AWS S3
          # pip install awscli
          # aws s3 sync s3://your-bucket/models/ models/
          
          # ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ (ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÑƒÑÑ‚Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹)
          touch models/arxora_m7pro_AAPL.joblib
          touch models/arxora_m7pro_TLT.joblib
          
          echo "Models downloaded successfully"

      - name: Add models to Git LFS
        run: |
          git lfs track "*.joblib"
          git add .gitattributes
          git add models/

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet . || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.verify_diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Auto-update models [skip ci]"
          title: "ðŸ¤– Auto-update models"
          body: |
            ## ðŸ“¦ Auto-updated models
            
            This PR was automatically created by GitHub Actions.
            
            ### Changes:
            - Updated ML models in `models/` directory
            - Automated by workflow: `update.yml`
            
            ### Models updated:
            - `arxora_m7pro_AAPL.joblib`
            - `arxora_m7pro_TLT.joblib`
            - `arxora_m7pro_TSLA.joblib`
            - `arxora_m7pro_X_BTCUSD.joblib`
            - `arxora_m7pro_X_ETHUSD.joblib`
            - `octopus_meta.joblib`
            
            ---
            ðŸ¤– **Automated update** â€¢ Created at: ${{ github.run_id }}
          branch: auto-update-models-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            models
            bot
