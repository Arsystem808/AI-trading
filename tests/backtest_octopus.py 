import pytest
import json
from pathlib import Path
from core.strategy import analyze_asset_global, analyze_asset_m7, analyze_asset_w7

def pytest_addoption(parser):
    parser.addoption("--ticker", action="store", help="Ticker to backtest")
    parser.addoption("--output", action="store", help="Output JSON path")

@pytest.fixture
def ticker(request):
    return request.config.getoption("--ticker")

@pytest.fixture
def output_path(request):
    return request.config.getoption("--output")

def test_single_ticker(ticker, output_path):
    """Backtest Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ‚Ð¸ÐºÐµÑ€Ð° Ð´Ð»Ñ Octopus"""
    print(f"\nðŸ” Backtesting {ticker.upper()}...")
    
    # Ð’Ñ‹Ð·Ð¾Ð² Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
    models_results = []
    models = [
        ("Global", lambda: analyze_asset_global(ticker, "ÐšÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ð¹")),
        ("M7", lambda: analyze_asset_m7(ticker, "ÐšÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ð¹", use_ml=True)),
        ("W7", lambda: analyze_asset_w7(ticker, "ÐšÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ð¹")),
    ]
    
    for model_name, model_func in models:
        try:
            signal = model_func()
            models_results.append({
                "model": model_name,
                "action": signal["recommendation"]["action"],
                "confidence": signal["recommendation"]["confidence"],
                "levels": signal["levels"],
                "probs": signal["probs"],
            })
            print(f"  âœ… {model_name}: {signal['recommendation']['action']} "
                  f"(conf: {signal['recommendation']['confidence']:.2f})")
        except Exception as e:
            print(f"  âŒ {model_name}: {e}")
            models_results.append({
                "model": model_name,
                "error": str(e)
            })
    
    # Octopus Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ
    valid_results = [r for r in models_results if "action" in r]
    if valid_results:
        actions = [r["action"] for r in valid_results]
        consensus = max(set(actions), key=actions.count)
        avg_conf = sum(r["confidence"] for r in valid_results) / len(valid_results)
    else:
        consensus = "WAIT"
        avg_conf = 0.5
    
    result = {
        "ticker": ticker,
        "consensus_action": consensus,
        "avg_confidence": round(avg_conf, 4),
        "models": models_results,
    }
    
    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
    Path(output_path).parent.mkdir(parents=True, exist_ok=True)
    with open(output_path, "w") as f:
        json.dump(result, f, indent=2)
    
    print(f"ðŸ’¾ Saved to {output_path}")
    assert len(valid_results) > 0, f"No valid signals for {ticker}"
